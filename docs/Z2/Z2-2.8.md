# 2.8 Logging de Acesso & Integração com Z9

*(sem log forte, não existe “cofre”: existe “disco caro”)*

Na Z2 vivem os dados brutos mais sensíveis da casa. Se alguém acessa, altera, lista ou tenta apagar algo e isso **não deixa rastro forte**, você perdeu a narrativa de segurança, de auditoria e de confiabilidade dos modelos.

Princípio central:

> **Tudo que encosta na Raw Zone é registrado, atribuído a uma identidade, correlacionado com o resto do ambiente e monitorado em Z9.**
> Sem logging e monitoramento, você viola direto OWASP A09 (Logging & Monitoring Failures).

---

## 2.8.1 Objetivo (o que o logging da Z2 precisa garantir)

O módulo de logging & integração com Z9 deve permitir que você:

1. **Saiba quem fez o quê, onde, quando e como** em Z2.
2. **Detecte desvios e abusos** (ex.: leitura massiva de PII, deleções suspeitas).
3. **Comprove para auditor/regulador**:

   * que acessos são controlados,
   * que dados não foram alterados silenciosamente,
   * que incidentes são detectáveis e investigáveis.

Sem isso:

* você cai em **Security Logging & Monitoring Failures** (OWASP Top 10),
* quebra controles NIST AU-2/AU-6/AU-9,
* não consegue sustentar requisitos de bancos, LGPD, auditorias.

---

## 2.8.2 O que deve ser logado na Z2 (mínimo obrigatório)

Tudo que envolva **interação com o storage da Raw Zone** precisa gerar eventos estruturados.
Pense em três categorias: **acesso**, **modificação**, **política**.

1. **Acesso a dados (Read/Write/List)**

   * `actor_id` / `service_account` / usuário humano.
   * `source_ip` / `pod` / `node` / `VPC`.
   * operação:

     * `GET`, `PUT`, `DELETE`, `LIST`, `HEAD`, `COPY`, etc.
   * recurso:

     * bucket + key/prefixo (`raw/core-transacoes/...`).
   * resultado:

     * `success` / `denied` / `error` (com código).
   * tamanho aproximado do objeto acessado (para detectar exfiltração massiva).

2. **Modificações & versionamento**

   * criação de novo objeto,
   * sobrescrita (com registro de `versionId` antigo e novo),
   * deleção (incluindo quem tentou, se foi bloqueado por WORM/policy).

3. **Eventos de política & IAM**

   * criação/alteração de policies de bucket,
   * concessão/revogação de permissões,
   * criação/rotação/revogação de credenciais de acesso.

4. **Eventos de exceção e erros**

   * falhas de autenticação,
   * tentativas de acessar prefixos não permitidos,
   * tentativas de escrever sem criptografia ou fora do padrão,
   * estouros de quota / erros de espaço / falha de replicação.

Esses logs devem ser **estruturados (JSON)** para facilitar correlação em Z9.

---

## 2.8.3 O que **não** logar (pra não criar outro problema)

Logging ruim também é risco de segurança.

Evitar:

* armazenar em log:

  * conteúdo de arquivos (CSV, PDF, imagens),
  * PII em claro (CPF, cartão, senha, token),
  * segredos (`Authorization`, `AccessKey`, `refresh_token`).
* permitir que usuários consultem diretamente os logs de storage sem filtro (pode vazar info sensível).

Boas práticas:

* logar **metadados**, não payload.
* mascarar identificadores sensíveis quando necessário.
* validar/escapar conteúdo antes de logar pra evitar **log injection** (tema explícito em OWASP A09:2025).

---

## 2.8.4 Integração com Z9 — Monitoring, SIEM & Detecção

Z2 não analisa sozinha seus próprios logs. Ela **alimenta Z9**, que centraliza visão e correlação.

Fluxo típico:

1. Storage (MinIO/S3-like) gera **access logs** e **audit logs**.
2. Esses logs são enviados para:

   * stack de observabilidade (ELK / Loki / OpenSearch / Splunk / etc.),
   * ou diretamente para um **SIEM**.
3. Z9 consolida:

   * logs da Z1 (gateway, WAF, AV, AuthN),
   * logs da Z2 (storage, IAM),
   * logs de Z4/Z5 (CI/CD, registry, training),
   * logs de Z8 (Vault, KMS, IdP).

Isso permite:

* **correlação ponta a ponta**:

  * “esse modelo foi treinado com dados lidos por tal service account,
    que leu esses objetos em Z2,
    que vieram dessas requisições em Z1.”
* **detecção de incidentes**:

  * leitura massiva fora do horário,
  * tentativas de acesso negadas em lote,
  * uso de credencial inativa/comprometida.

---

## 2.8.5 Alertas & Detecção de Anomalias (o que monitorar de verdade)

Alguns casos de uso que você pode citar (e simular no lab):

1. **Exfiltração de dados**

   * Vários `GET` grandes de buckets `raw/fraude/**` por uma única conta em pouco tempo.
   * Ação:

     * alertar SOC,
     * bloquear temporariamente a credencial (via IAM/Vault),
     * abrir incidente.

2. **Tentativa de bypass / shadow access**

   * Requisições de IPs ou pods não autorizados tentando acessar Z2.
   * Ação:

     * alerta imediato,
     * checar se há misconfig de rede ou intrusão.

3. **Quebra de políticas de WORM / deleções suspeitas**

   * Tentativas de `DELETE` em objetos com retenção ativa.
   * Muitos deletes em sequência pelo mesmo usuário.
   * Ação:

     * alerta,
     * revisão de credenciais/políticas.

4. **Uso anômalo de contas privilegiadas**

   * Conta de `admin` acessando dados de múltiplos domínios sem motivo.
   * Ação:

     * investigar contexto,
     * aplicar princípio de least privilege.

---

## 2.8.6 Implementação no MLOps Security Lab

No lab você não precisa de um SIEM pesado, mas pode mostrar claramente a intenção:

1. **Configurar logs do MinIO**

   * Ativar:

     * `server log` (access logs),
     * `audit logs` (se disponíveis).
   * Formato JSON, incluindo:

     * `time`, `remoteHost`, `requestID`, `user`, `bucket`, `object`, `operation`, `status`.

2. **Centralizar em um stack de observabilidade simples**

   * Exemplo:

     * **Loki + Promtail + Grafana** ou **ELK**.
   * Dashboards:

     * “Top buckets acessados”,
     * “Top service accounts por volume de leitura”,
     * “Falhas de autenticação em Z2”.

3. **Regras de alerta básicas**

   * `> N` falhas de Auth em 5 minutos → alerta.
   * `> X GB` lidos de um bucket sensível em 10 minutos → alerta.
   * Tentativa de acesso a `quarantine/` por conta não autorizada → alerta crítico.

4. **Correlação com Z1**

   * Propagar `X-Request-Id` / `Correlation-Id` da Z1 para os jobs de ingestão,
   * incluir esse ID nos metadados/nomes de arquivos,
   * logar o mesmo ID em Z2,
   * mostrar no doc: como rastrear uma jornada completa.

---

## 2.8.7 Alinhamento com Frameworks & Riscos

**Frameworks**

* **OWASP Top 10 / API & AppSec**

  * A09:2021 / A09:2025 — *Security Logging & Monitoring / Logging & Alerting Failures*.
* **NIST SP 800-53 Rev.5**

  * **AU-2** (Event Logging),
  * **AU-6** (Audit Review, Analysis, and Reporting),
  * **AU-9** (Protection of Audit Information),
  * **SI-4** (System Monitoring).
* **CSA CCM v4**

  * **LOG** (Logging & Monitoring),
  * **IAM**, **DSI**, **GRC** (para quem pergunta de governança).

**Riscos de Z2 mitigados (ligando com a seção 3)**

* 3.1 — Vazamento de dados brutos → Detecção de acessos anômalos e exfiltração.
* 3.2 — Alteração não autorizada → Logs de write/delete + versionamento + WORM.
* 3.3 — Exclusão maliciosa → Tentativas de delete rastreadas e bloqueadas.
* 3.5 — Shadow pipelines → Logs evidenciam origens não autorizadas.
* 3.6 — Falta de proveniência → Correlação Z1/Z2/Z9 garante trilha completa.
