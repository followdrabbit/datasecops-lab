# 2.4 Controles de Acesso (IAM / ABAC / Least Privilege)

Se a **Z2 é o cofre**, o módulo de **IAM/ABAC** é quem decide **quem pode abrir qual gaveta, como e quando**.
Sem controle de acesso fino, toda criptografia e isolamento de rede viram cenário de “chave mestra no post-it”.

Princípio central:

> **Ninguém acessa a Raw Zone anonimamente, e ninguém tem mais permissão do que precisa.
> Acesso é por identidade forte, com política explícita, auditável e alinhada ao negócio.**

---

## 2.4.1 Papéis que interagem com a Z2

Primeiro, deixa claro **quem** fala com Z2. Em vez de “todo mundo com a mesma chave”, definimos perfis.

Perfis típicos:

1. **Conectores de Ingestão (Z1 → Z2)**

   * Ex.: `svc-airflow-ingest-core`, `svc-ingest-parceiro-x`, `svc-kafka-consumer-raw`.
   * Permissões:

     * `write` (e às vezes `list` limitado) apenas nos buckets/prefixos da sua fonte.
     * sem `delete` amplo, sem acesso a dados de outras fontes.

2. **Pipelines de Curadoria (Z3)**

   * Ex.: `svc-curation-fraude`, `svc-curation-crm`.
   * Permissões:

     * `read` restrito aos datasets necessários em `raw/...`,
     * `write` apenas em `curated/...`,
     * nunca sobrescrever diretamente Raw.

3. **Plataforma de Modelagem (Z4)**

   * Ex.: `svc-ml-training-fraud`, `svc-mlflow-artifacts`.
   * Permissões:

     * leitura apenas em subsets de Z2 (via Z3 preferencialmente),
     * ou acesso direto a Raw somente quando justificado, com políticas específicas.

4. **Segurança / Auditoria (Z8/Z9)**

   * Ex.: `svc-siem`, `svc-dlp`, `audit-team`.
   * Permissões:

     * leitura de metadados e logs,
     * acesso a dados brutos só quando necessário, altamente auditado.

5. **Usuários humanos**

   * Idealmente:

     * acesso indireto via ferramentas (Athena/Trino/Metabase) apontando para Z3,
     * acesso direto a Z2 apenas sob perfil especial, com justificativa + auditoria.

---

## 2.4.2 IAM: identidades fortes, nunca “usuário genérico”

**Regras de ouro:**

1. **Identidade individual ou de serviço**

   * Cada sistema tem seu próprio **service account**.
   * Cada pessoa usa seu próprio usuário vinculado ao IdP (ex.: Keycloak/AD).
   * Nada de:

     * `user=mlops_admin` compartilhado,
     * chaves S3/MinIO copiadas em mil lugares.

2. **Integração com IdP + Vault**

   * Service accounts e apps pegam credenciais de acesso à Z2 via:

     * **Vault** (AppRole, JWT/OIDC, Kubernetes auth, etc.).
   * Usuários humanos:

     * autenticam no IdP,
     * recebem roles/grupos mapeados para policies (ex.: `role:data-engineer-raw-read`).

3. **Sessões curtas & rotação**

   * Tokens/chaves com validade curta.
   * Rotação automática (GitHub OIDC + Vault + KMS).
   * Revogação rápida se um serviço ou usuário vaza.

---

## 2.4.3 ABAC (Attribute-Based Access Control) na prática

RBAC (roles fixos) é bom, mas em dados complexos você ganha muito com **ABAC**:
políticas baseadas em atributos do sujeito, do recurso e do contexto.

Atributos úteis para Z2:

* **Do sujeito (quem acessa)**:

  * `role`: `ingest`, `curation`, `ml_training`, `audit`.
  * `tenant`: `bankA`, `bankB`.
  * `department`: `fraude`, `credito`, `analytics`.
* **Do recurso (dado)**:

  * `source_system`: `core-transacoes`, `parceiro-x`.
  * `classification`: `public`, `internal`, `restricted`, `pii`, `secret`.
  * `zone`: `raw`, `quarantine`, `curated`.
* **Do contexto**:

  * ambiente: `prod`, `staging`, `dev`.
  * horário, localização, tipo de requisição.

Exemplo de política ABAC (conceitual):

> “Service accounts com atributo `role=ingest` e `source_system=parceiro-x`
> podem escrever apenas em `raw/parceiro-x/**`, das 06h às 22h, a partir da VPC de integração,
> usando chave KMS `kms-key/raw-parceiro-x`.”

Benefícios:

* Isolamento entre parceiros/tenants.
* Redução de privilégio automático quando muda o contexto.
* Excelente história pra contar em entrevista (ABAC é buzzword com conteúdo real).

---

## 2.4.4 Princípio do Least Privilege (privacidade & risco)

Tudo em Z2 é projetado com **privilégio mínimo**:

* Se o conector só precisa **escrever** → não ganha `read` global.
* Se o data scientist só precisa de features em Z3 → não ganha acesso bruto a Z2.
* Se um pipeline só precisa de um dataset → não ganha wildcard no bucket todo.

Pontos práticos:

* Evitar políticas tipo:

  * `s3:*` em `raw/*`.
* Preferir:

  * `s3:PutObject` em `raw/parceiro-x/**` para `svc-ingest-parceiro-x`.
  * `s3:GetObject` apenas em `raw/core-transacoes/year=2025/**` para um job específico.

Isso:

* reduz blast radius em caso de vazamento de credencial,
* reduz risco de uso indevido de PII,
* ajuda a cumprir LGPD/compliance (minimização de acesso).

---

## 2.4.5 Enforcement técnico (como amarrar tudo)

Como garantir que essas regras não sejam “só desenho bonito”:

1. **Policies como código**

   * Definir usuários, roles, policies de bucket / MinIO / S3 via Terraform/Helm.
   * Revisadas em PR, versionadas, auditáveis.

2. **Integração com o gateway e Vault**

   * O mesmo IdP e as mesmas identidades valem para:

     * Z1 (ingestão),
     * Z2 (storage),
     * Z4/Z5 (modelos),
     * Z8 (segurança).
   * Consistência de papéis e claims (RBAC/ABAC de ponta a ponta).

3. **Testes automáticos de permissão**

   * Jobs que validam:

     * se existe algum usuário com permissão ampla demais,
     * se existe bucket acessível fora da rede,
     * se policies estão em conformidade com o padrão.

4. **Log & Monitoramento**

   * Tudo que passa pelo IAM do storage é logado (2.8):

     * `who did what on which object, when`.
   * Integração com Z9/SIEM:

     * alerta se alguém tentar listar/ler algo fora do escopo,
     * detectar brute-force, uso estranho de chaves, etc.

---

## 2.4.6 Alinhamento com Frameworks

Esse item conversa direto com:

* **NIST SP 800-53 Rev.5**

  * **AC-1..AC-6** (política, contas, least privilege, separação de funções),
  * **IA-2** (identificação/autenticação),
  * **SC-12/SC-13** (gestão de chaves, quando combinado com 2.2).
* **CSA Cloud Controls Matrix (CCM v4)**

  * **IAM-xx** (Identity & Access Management),
  * **AAC**, **DSI**, **LOG** (acesso, dados, auditoria).

Pitch pra entrevista:

> “Na Z2, não existe acesso implícito. Tudo é via service accounts e identidades do IdP, com políticas de least privilege por bucket/prefixo e, idealmente, ABAC por fonte, sensibilidade e ambiente. Isso garante que mesmo se alguém comprometer um componente, a superfície de dados brutos exposta é mínima e rastreável.”
