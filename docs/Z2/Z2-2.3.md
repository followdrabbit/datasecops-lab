# 2.3 Network Isolation & Endpoint Policy (Raw sem porta pra rua)

A **Raw Zone só é segura se o caminho de rede até ela for estritamente controlado**.
Não adianta criptografia, IAM e logs se o bucket/MinIO ou o banco de dados estão acessíveis de qualquer lugar da internet ou de qualquer microserviço do cluster.

Princípio central:

> **Z2 não tem “porta pra rua”.
> Quem quer ler ou escrever em Z2 precisa vir de dentro de uma rede confiável + identidade autorizada + caminho oficial.**

---

## 2.3.1 Objetivo

Network Isolation & Endpoint Policy na Z2 garante que:

1. Dados brutos só são acessíveis **a partir de ambientes controlados** (Z1/Z3/Z4/Z8).
2. Não exista acesso direto público ou “atalhos” (buckets abertos, serviços expostos).
3. Todo tráfego até Z2 seja:

   * autenticado,
   * autorizado,
   * observado,
   * e, preferencialmente, criptografado (TLS).

Isso reduz:

* risco de vazamento direto (S3 público, MinIO aberto),
* risco de bypass da Z1,
* superfície de ataque contra o storage.

---

## 2.3.2 Padrão Arquitetural (como deve ser)

A arquitetura de rede da Z2 deve seguir alguns princípios:

1. **Sub-redes privadas**

   * Z2 (MinIO/Postgres/outros storages) roda em **subnets privadas** (sem IP público).
   * Sem listener HTTP exposto direto na internet.

2. **Acesso apenas via caminhos controlados**

   * Serviços que podem falar com Z2:

     * Ingestion Gateway / conectores oficiais (2.7),
     * pipelines de curadoria (Z3),
     * fábrica de modelos (Z4) via service accounts,
     * serviços de segurança (Z8) e monitoração (Z9) para logs/integração.
   * Esses serviços também precisam:

     * estar em redes autorizadas,
     * passar por autenticação mútua (mTLS / identidade de workload / Kubernetes ServiceAccount + NetworkPolicy, etc.).

3. **Network Policies / Security Groups**

   * Use mecanismos da sua plataforma para restringir:

     * **quem pode abrir conexão para Z2**,
     * porta/protocolo permitido (ex.: só 443/9000 interno),
     * nada de “0.0.0.0/0” apontando pro storage.

4. **Endpoints privados / VPC Endpoints**

   * Em cloud:

     * use **VPC Endpoints** (ex.: AWS PrivateLink) para acessar S3/KeyVault/etc.
   * Em on-prem / lab:

     * use redes internas (Docker network / bridge interna / VLAN),
     * exponha o MinIO apenas nesse domínio interno.

---

## 2.3.3 Como isso aparece na prática (exemplos concretos)

Alguns cenários típicos que você pode descrever no lab ou numa entrevista:

* **MinIO na VPS**

  * Rodando em uma rede Docker interna (`internal_network`),
  * só acessível por:

    * containers do Airflow,
    * serviços de ingestão,
    * serviços de curadoria,
    * via nomes internos (`http://minio:9000`),
  * nenhuma porta do MinIO publicada diretamente na internet.

* **Nginx/Traefik como única borda**

  * Porta 80/443 pública só do reverse proxy.
  * Reverse proxy **não** faz passthrough pra Z2.
  * Z2 não tem rota externa; tudo é interno.

* **Kubernetes + NetworkPolicy**

  * Namespace `data-plane` com pods do MinIO/Postgres.
  * NetworkPolicy permitindo tráfego **apenas** de pods:

    * do namespace `ingestion` (Z1),
    * do namespace `mlops` (Z3/Z4),
    * do namespace `security` (Z8),
  * drop para qualquer outra origem.

---

## 2.3.4 Endpoint Policy (quem pode falar com o storage e como)

Além do “onde pode conectar”, precisamos do “**como** e **quem** conecta”.

Boas práticas:

1. **Whitelisting de origens**

   * Definir explicitamente quais IPs/subnets/pods podem:

     * listar,
     * ler,
     * escrever.
   * Ex.: só `svc-airflow-ingest`, `svc-curation`, `svc-mlflow` têm acesso.

2. **mTLS / Identidade de Workload**

   * Quando possível:

     * usar certificados de cliente ou identidade de workload (SPIRE, Istio, etc.).
   * O storage só aceita conexões:

     * de clientes com certificado/identidade confiável.

3. **Políticas por caminho/bucket**

   * Combinar rede + IAM:

     * Ex.: mesmo dentro da rede certa, o serviço X só pode escrever em `raw/core-transacoes/*`,
     * e não pode ler `raw/fraude/*` ou `raw/kyc_docs/*`.

4. **Sem saída lateral desnecessária**

   * Evitar que o storage chame a internet pra fora (ex.: callbacks, plugins).
   * Se precisar (ex.: replicação), isolar e logar.

---

## 2.3.5 Integração com Z1, Z3, Z4 e Z8

**Com Z1 (Ingestion & Security Gateway)**

* Apenas os **conectores oficiais** em Z1 (2.7) conseguem gravar na Raw Zone.
* Rede + IAM asseguram que:

  * mesmo que alguém tente atingir Z2 de fora → não chega.

**Com Z3 (Curated) & Z4 (Model Factory)**

* Esses ambientes leem da Raw Zone via:

  * sub-redes internas,
  * service accounts,
  * policies específicas.
* Opcional:

  * uso de endpoints lógicos tipo `raw://core-transacoes/...` resolvidos por um “Data Access Service” que aplica políticas de Z8.

**Com Z8 (Security & Trust Services)**

* Serviços como:

  * IAM, Vault, KMS, SIEM,
  * também ficam em redes internas.
* Z2 conversa com Z8 para:

  * validar credenciais,
  * obter chaves (KMS/ Vault),
  * enviar logs de acesso.

---

## 2.3.6 Erros clássicos para evitar (ótimo para comentar na entrevista)

Lista rápida de anti-patterns que você pode citar como “não faremos no lab / produção”:

1. **Bucket público**

   * `raw-bucket` expondo `ListObjects`/`GetObject` pra internet.
2. **MinIO com porta 9000 aberta pro mundo**

   * “É só pra testar” → alguém acha.
3. **Security Group 0.0.0.0/0**

   * Qualquer IP do planeta pode tentar conectar.
4. **Todos os pods do cluster acessam Z2**

   * Falta de NetworkPolicy; qualquer microserviço comprometido vaza Raw.
5. **Bypass do Gateway**

   * Serviço externo falando direto com o storage, sem passar pela Z1.

Resumo forte:

> Se você consegue apontar um `curl` da sua máquina pro endpoint do Raw e funciona, a Z2 não está isolada. Isso é bug, não feature.

---

## 2.3.7 Relação com Frameworks & Requisitos de Mercado

**NIST SP 800-53**

* **SC-7** — Boundary Protection: segmentação de rede, filtragem de tráfego.
* **SC-32** — Information System Partitioning.
* **SC-8** — Proteção de comunicações.
* **AC-4** — Enforcement de fluxos de informação permitidos.

**CSA Cloud Controls Matrix**

* **IVS-** (Virtualization / Compute / Network Security),
* **AIS / DSI** (segurança de interfaces e dados),
* **IPY / SEF** (segregação de funções e ambientes).

**Reguladores / Bancos**

* “Sem exposição direta de dados sensíveis na internet.”
* “Acesso apenas via redes e canais autorizados, com segregação clara entre zonas.”
