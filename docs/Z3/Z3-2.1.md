# Z3-2.1 — Curated Zone (Camada Curada, Governada e Versionada)

A **Curated Zone** é onde o dado bruto da Z2 vira **dado utilizável e confiável** para analytics e ML.
Aqui aplicamos **contratos de schema**, **regras de negócio**, **limpeza**, **minimização/mascaramento de PII**, **qualidade como código** e **versionamento semântico**. É a **fonte oficial de leitura** para Z4 (treino) e consumidores internos (Z7), enquanto a Feature Store (Z3-2.6) deriva (e publica) *features* a partir daqui.

---

## 1) Objetivo & Escopo

* **Objetivo**: produzir datasets **consistentes, estáveis e auditáveis**, prontos para consumo.
* **Escopo**:

  * Tabelas/arquivos curados por **domínio** (fraude, risco, canais, CRM, etc.).
  * Regras de negócio e **padronização** (tipos, unidades, dicionários de valores).
  * **Privacidade**: mascaramento, tokenização/pseudonimização quando o identificador não é necessário.
  * **Qualidade**: *gates* automáticos (completude, unicidade, ranges, chaves, outliers).
  * **Proveniência**: lineage explícito para Z2 e para *pipelines* de transformação.

---

## 2) Princípios da Curated Zone

1. **Só entra o que vem da Z2** (e fontes internas oficiais) — nunca direto de Z0/Z1.
2. **Contratos de dados são lei** (schema versionado e validado “como código”).
3. **Privacidade por padrão** (minimização; PII apenas quando estritamente necessário).
4. **Imutabilidade lógica**: mudanças relevantes criam **novas versões** do dataset.
5. **Observável**: *freshness*, volume, qualidade e acessos monitorados e auditáveis.

---

## 3) Entradas & Saídas (visão prática)

* **Entradas**: partições/tópicos **raw** da Z2 (Parquet/JSON/CSV), metadados (hash, schema_version, fonte, timestamps).
* **Saídas**:

  * **Tabelas curadas** (ex.: `curated.risco_transacoes_v2` em DW/warehouse ou Parquet particionado).
  * **Views materializadas** para consumo analítico.
  * **Feeds** para Feature Store (offline) e, indiretamente, Feature Store online.

**Naming padrão (exemplo):**

```
curated/<dominio>/<dataset>/v<major>/
  year=<yyyy>/month=<mm>/day=<dd>/part-0000.snappy.parquet
```

ou em DW: `curated_<dominio>_<dataset>_v<major>`.

---

## 4) Transformações típicas (o que acontece aqui)

* **Padronização de tipos** (datas, numéricos, enums).
* **Normalização de unidades** (moeda, timezone, decimais).
* **Deduplicação e *merge* lógico** (chaves naturais/surrogates).
* **Enriquecimento autorizado** (*lookups* internos devidamente versionados).
* **Regras de negócio** (ex.: status de contrato, *flags* de fraude, elegibilidade).
* **Minimização/PII**:

  * manter **token**/hash determinístico quando o identificador real não é necessário;
  * **separação física** de colunas sensíveis em *tablespaces* ou áreas “restricted”.

---

## 5) Contratos de Schema & Compatibilidade

* **Definição**: schema em **arquivos versionados** (Avro/JSON/DDL) no repositório do *pipeline*.
* **Compatibilidade**:

  * *Minor* (compatível para trás): **adicionar** coluna opcional, ampliar domínio.
  * *Major* (quebra contrato): **remover/renomear** coluna, alterar semântica → **novo dataset vN+1**.
* **Validação**:

  * em **CI** (PR falha se o schema quebrar regras),
  * em **runtime** (jobs rejeitam lotes incompatíveis).

---

## 6) Qualidade de Dados como Código (DQ Gates)

* **Regras**: completude (não nulos), unicidade (chaves), integridade referencial, ranges plausíveis, distribuição (desvios), *business checks*.
* **Política de promoção**:

  * *PASS*: promove para Curated;
  * *WARN*: promove com *flag* e abre tarefa de análise;
  * *FAIL*: envia para **Staging/Quarentena** (Z2-2.7), gera incidente.
* **Evidências**: relatórios DQ anexados ao *run* (hash, lote, *timestamp*, contador de violações).

---

## 7) Privacidade, PII e Minimização

* **Classificação**: cada coluna recebe *labels* (`public/internal/confidential/restricted`, `pii`, `financial`, `secret`).
* **Pseudonimização/tokenização**:

  * **token determinístico** para *joins* seguros sem expor o identificador;
  * **token não reversível** para análises agregadas.
* **Mascaramento por perfil**:

  * RBAC/ABAC por consumo (Z8): *analyst* vê token; *KYC-team* vê identificador real (apenas quando necessário e logado).
* **Logs e auditoria**: acessos a colunas PII são **registrados e correlacionados** (Z9).

---

## 8) Versionamento semântico & Deprecação

* **Versões explícitas**: `curated.risco_transacoes_v1`, `v2`, …
* **Deprecação**:

  * publicar *END-OF-LIFE* e janelas de migração,
  * manter *views* de compatibilidade quando possível,
  * bloqueio de criação em versões antigas após prazo.

---

## 9) Fluxo de Promoção (Staging → Curated)

1. **Ingest & staging**: ler partições de Z2 para área temporária.
2. **Transform**: aplicar regras de negócio, padronização e PII.
3. **Validate (DQ + Schema)**: executar *suite* de testes.
4. **Write (atomic)**: gravar partições novas em `curated/...` (ou *table* DW).
5. **Publish & tag**: escrever *manifest* (hashes, *run_id*, versão de código, de *deps*, *data_time window*).
6. **Notify**: atualizar Catálogo/Lineage e notificar dependentes (Feature Store, APIs).
7. **Rollback**: se necessário, reverter para partições anteriores (apoio do versionamento e *manifests*).

---

## 10) Metadados obrigatórios por partição/dataset

* `source_refs` (paths/versions/hashes de Z2),
* `pipeline_id` / `code_version` / *git sha*,
* `dq_report_ref` (link do relatório de qualidade),
* `schema_version` (contrato aplicado),
* `privacy_profile` (colunas PII/tokenizadas),
* `produced_at` (UTC) / janela de dados (start/end),
* `owner` (time responsável) / `sla` (freshness e latência).

---

## 11) IAM & Acesso (compliance com Z8)

* **Produtores** (DAGs de curadoria): *service accounts* com `write` somente no seu domínio/prefixo.
* **Consumidores**:

  * **Z4**: leitura de datasets aprovados; idealmente via *data products* ou Feature Store.
  * **Z7**: *apps* internos com *views* específicas (não *full table*).
* **Humano**:

  * acesso **indireto** (BI/SQL padronizado) e com **perfil**;
  * leitura de PII **apenas** para *roles* aprovadas e logado.

---

## 12) Observabilidade & Operação

* **Métricas**: *freshness*, volume por partição, *throughput*, tempo de *job*, taxa de *FAIL/WARN* de DQ.
* **Alertas**:

  * atraso de *freshness*,
  * aumento abrupto de *nulls*,
  * *schema drift*,
  * leituras fora do padrão em tabelas sensíveis.
* **Logs**: *runs* de DAGs, *manifests* publicados, auditoria de acesso (Z9).

---

## 13) Riscos mitigados (e como)

* **Garbage in → garbage model**: DQ como código + contratos.
* **Leakage/PII indevida**: minimização, tokenização, RBAC/ABAC e *logs*.
* **Schema drift silencioso**: *registry* + validação em CI/runtime.
* **Treino inconsistente**: versionamento semântico, *manifests*, lineage.
* **Bypass da Z3 (ler Z2 direto)**: políticas de acesso e *data products* oficiais.

---

## 14) Implementação no Lab (passo a passo)

* **Armazenamento Curated**:

  * *Option A*: Parquet particionado em `curated/...` (MinIO, interno).
  * *Option B*: Postgres/ClickHouse como DW interno (rede privada).
* **Pipelines (Airflow)**:

  * `curate_<dominio>_<dataset>_vN`

    * *Tasks*: `extract_from_raw` → `transform_curate` → `dq_validate` → `write_curated` → `publish_manifest` → `update_catalog`.
* **Schemas & DQ**:

  * schemas em `/schemas/curated/<dataset>/vN/` (JSON/DDL),
  * *suites* DQ em `/dq/<dataset>/vN/` (YAML/py),
  * validação em **CI** + runtime (falhou = não promove).
* **Privacidade**:

  * *udfs* de tokenização determinística (ex.: HMAC-SHA256 com *salt* do Vault Transit),
  * *views* mascaradas para perfis analíticos.
* **Catálogo/Lineage**:

  * arquivo `manifest.json` por *run* (refs de Z2, hashes, *git sha*, DQ),
  * *script* que atualiza o “catálogo” (simplificado no lab) e desenha lineage.
* **Acesso**:

  * *service accounts* separadas `svc-curate-<dominio>`, `svc-read-<dominio>`,
  * *policies* (Vault/MinIO/DB) com **least privilege**.

---

## 15) Anti-patterns a evitar (ótimos na entrevista)

* “Puxar de Z2 direto pro modelo porque é mais rápido”.
* Liberar PII “temporariamente” em *views* de uso amplo.
* Mudar schema “no braço” (sem versão/contrato).
* DQ em planilha / sem *gate* de promoção.
* Dataset *mutável* sem *manifests* e sem como reproduzir um *run*.

---

## 16) Checklist de Aceite (pronto para produção)

* [ ] *Pipeline* tem **schema** versionado e validado.
* [ ] *Suite* DQ definida; *gate* impede promoção em **FAIL**.
* [ ] **PII** minimizada/tokenizada; *views* mascaradas conforme perfil.
* [ ] **Manifest** publicado com refs a Z2, *git sha*, *dq_report*, janela de dados.
* [ ] **Versionamento semântico** aplicado (`vN`); plano de deprecação documentado.
* [ ] **IAM** com *least privilege*; acessos auditáveis (Z9).
* [ ] **Métricas/alertas** de *freshness* e qualidade configurados.

> Com essa Z3-2.1, você mostra domínio de **data engineering + segurança + privacidade + MLOps**.
